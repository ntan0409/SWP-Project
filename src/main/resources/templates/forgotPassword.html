<div th:replace="~{header}"></div>

<header class="ex-header">
    <div class="container">
        <div class="row">
            <div class="col-xl-10 offset-xl-1">
                <h1 class="text-center">Forgot Password</h1>
            </div>
        </div>
    </div>
</header>

<div class="ex-form-1 pt-5 pb-5">
    <div class="container">
        <div class="row">
            <div class="col-xl-6 offset-xl-3">
                <div class="text-box mt-5 mb-5">
                    <div class="mb-4">
                        <h5>Reset Your Password</h5>
                        <p class="text-muted">Enter your email address and we'll send you instructions to reset your password.</p>
                        </div>

                    <form id="emailForm" action="/forgot-password" method="post">
                        <div class="mb-4 form-floating">
                            <input type="email" 
                                   class="form-control" 
                                   id="floatingEmail" 
                                   placeholder="Email" 
                                   name="email" 
                                   required
                                   autocomplete="email">
                            <label for="floatingEmail">Email address</label>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="form-control-submit-button">
                                <i class="fas fa-paper-plane me-2"></i>Send OTP
                            </button>
                            <a href="/login" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Login
                            </a>
                        </div>
                    </form>

                    <!-- Success Message -->
                    <div id="successMessage" class="alert alert-success alert-dismissible fade d-none mt-4" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        OTP has been sent to your email.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>

                    <!-- Error Message -->
                    <div id="errorMessage" class="alert alert-danger alert-dismissible fade d-none mt-4" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <span id="errorText">Error message here</span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="ex-form-1 pt-5 pb-5">
    <div class="container">
        <div class="row">
            <div class="col-xl-6 offset-xl-3">
                <div class="text-box mt-5 mb-5">
                    <div class="mb-4">
                        <h5>Enter OTP</h5>
                        <p class="text-muted">Enter the OTP sent to your email.</p>
                    </div>

                    <form id="otpForm" action="/forgot-password" method="post">
                        <div class="mb-4 d-flex justify-content-between">
                            <div class="form-floating me-2">
                                <input type="text" 
                                       class="form-control otp-input" 
                                       id="otpInput1" 
                                       placeholder="OTP" 
                                       name="otpInput1" 
                                       required
                                       maxlength="1">
                                <label for="otpInput1">OTP</label>
                            </div>
                            <div class="form-floating me-2">
                                <input type="text" 
                                       class="form-control otp-input" 
                                       id="otpInput2" 
                                       placeholder="OTP" 
                                       name="otpInput2" 
                                       required
                                       maxlength="1">
                                <label for="otpInput2">OTP</label>
                            </div>
                            <div class="form-floating me-2">
                                <input type="text" 
                                       class="form-control otp-input" 
                                       id="otpInput3" 
                                       placeholder="OTP" 
                                       name="otpInput3" 
                                       required
                                       maxlength="1">
                                <label for="otpInput3">OTP</label>
                            </div>
                            <div class="form-floating me-2">
                                <input type="text" 
                                       class="form-control otp-input" 
                                       id="otpInput4" 
                                       placeholder="OTP" 
                                       name="otpInput4" 
                                       required
                                       maxlength="1">
                                <label for="otpInput4">OTP</label>
                            </div>
                            <div class="form-floating me-2">
                                <input type="text" 
                                       class="form-control otp-input" 
                                       id="otpInput5" 
                                       placeholder="OTP" 
                                       name="otpInput5" 
                                       required
                                       maxlength="1">
                                <label for="otpInput5">OTP</label>
                            </div>
                            <div class="form-floating">
                                <input type="text" 
                                       class="form-control otp-input" 
                                       id="otpInput6" 
                                       placeholder="OTP" 
                                       name="otpInput6" 
                                       required
                                       maxlength="1">
                                <label for="otpInput6">OTP</label>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="form-control-submit-button">
                                <i class="fas fa-check-circle me-2"></i>Verify OTP
                            </button>
                            <a href="/login" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Login
                            </a>
                        </div>
                    </form>

                    <!-- Success Message -->
                    <div id="otpSuccessMessage" class="alert alert-success alert-dismissible fade d-none mt-4" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        OTP verified successfully.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>

                    <!-- Error Message -->
                    <div id="otpErrorMessage" class="alert alert-danger alert-dismissible fade d-none mt-4" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <span id="otpErrorText">Error message here</span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="ex-form-1 pt-5 pb-5">
    <div class="container">
        <div class="row">
            <div class="col-xl-6 offset-xl-3">
                <div class="text-box mt-5 mb-5">
                    <div class="mb-4">
                        <h5>Enter New Password</h5>
                        <p class="text-muted">Enter your new password.</p>
                    </div>

                    <form id="passwordForm" action="/forgot-password" method="post">
                        <div class="mb-4 form-floating">
                            <input type="password" 
                                   class="form-control" 
                                   id="newPassword" 
                                   placeholder="New Password" 
                                   name="password" 
                                   required>
                            <label for="newPassword">New Password</label>
                            <div class="password-requirements small text-muted mt-2">
                                Password must contain:
                                <ul class="mb-0">
                                    <li id="length-check"><i class="fas fa-times text-danger"></i> At least 8 characters</li>
                                    <li id="uppercase-check"><i class="fas fa-times text-danger"></i> At least one uppercase letter</li>
                                    <li id="lowercase-check"><i class="fas fa-times text-danger"></i> At least one lowercase letter</li>
                                    <li id="number-check"><i class="fas fa-times text-danger"></i> At least one number</li>
                                    <li id="special-check"><i class="fas fa-times text-danger"></i> At least one special character (!@#$%^&*)</li>
                                </ul>
                            </div>
                            <div class="invalid-feedback" id="passwordError"></div>
                        </div>
                        <div class="mb-4 form-floating">
                            <input type="password" 
                                   class="form-control" 
                                   id="confirmPassword" 
                                   placeholder="Confirm Password" 
                                   name="confirmPassword" 
                                   required>
                            <label for="confirmPassword">Confirm Password</label>
                            <div class="invalid-feedback" id="confirmPasswordError"></div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="form-control-submit-button">
                                <i class="fas fa-save me-2"></i>Reset Password
                            </button>
                            <a href="/login" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Login
                            </a>
                        </div>
                    </form>

                    <!-- Success Message -->
                    <div id="passwordSuccessMessage" class="alert alert-success alert-dismissible fade d-none mt-4" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        Password reset successfully. Redirecting to login...
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>

                    <!-- Error Message -->
                    <div id="passwordErrorMessage" class="alert alert-danger alert-dismissible fade d-none mt-4" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <span id="passwordErrorText">Error message here</span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
let email = '';
let timer;

document.addEventListener('DOMContentLoaded', function() {
    initializeOTPInputs();
    setupForms();
});

function initializeOTPInputs() {
    const inputs = document.querySelectorAll('.otp-input');
    
    inputs.forEach((input, index) => {
        // Chỉ cho phép nhập số
        input.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });

        // Auto focus next input
        input.addEventListener('keyup', (e) => {
            if (e.key !== 'Backspace' && input.value) {
                if (index < inputs.length - 1) {
                    inputs[index + 1].focus();
                }
            }
            if (e.key === 'Backspace' && !input.value) {
                if (index > 0) {
                    inputs[index - 1].focus();
                }
            }
        });

        // Handle paste
        input.addEventListener('paste', (e) => {
    e.preventDefault();
            const pastedData = e.clipboardData.getData('text').slice(0, 6);
            if (/^\d+$/.test(pastedData)) {
                [...pastedData].forEach((digit, i) => {
                    if (inputs[i]) {
                        inputs[i].value = digit;
                        if (i < inputs.length - 1) {
                            inputs[i + 1].focus();
                        }
                    }
                });
            }
        });
    });
}

function setupForms() {


    document.getElementById('emailForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitButton = e.target.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';
        
        try {
            const response = await fetch('/api/forgot-password/send-otp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    email: document.getElementById('floatingEmail').value 
                })
            });

            if (!response.ok) {
                throw new Error('Failed to send OTP');
            }

            email = document.getElementById('floatingEmail').value;
            showStep('otpStep');
            startTimer();
            showAlert('OTP has been sent to your email', 'success');
        } catch (error) {
            showAlert(error.message, 'danger');
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Send OTP';
        }
    });

    document.getElementById('otpForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const otp = Array.from(document.querySelectorAll('.otp-input'))
            .map(input => input.value)
            .join('');

        if (otp.length !== 6) {
            showAlert('Please enter complete OTP', 'danger');
            return;
        }

        const submitButton = e.target.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Verifying...';

        try {
            const response = await fetch('/api/forgot-password/verify-otp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email, otp })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Invalid OTP');
            }

            showStep('passwordStep');
            showAlert('OTP verified successfully', 'success');
        } catch (error) {
            const otpErrorMessage = document.getElementById('otpErrorMessage');
            const otpErrorText = document.getElementById('otpErrorText');
            otpErrorText.textContent = error.message;
            otpErrorMessage.classList.remove('d-none');
            otpErrorMessage.classList.add('show');
            
            // Tự động ẩn thông báo sau 5 giây
            setTimeout(() => {
                otpErrorMessage.classList.remove('show');
                otpErrorMessage.classList.add('d-none');
            }, 5000);
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-check-circle me-2"></i>Verify OTP';
        }
    });

    // Password Reset Form Submit
    document.getElementById('passwordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const password = document.getElementById('newPassword').value;
        
        // Kiểm tra password requirements
        if (!validatePassword(password)) {
            showAlert('Please ensure your password meets all requirements', 'danger');
            return;
        }

        // Kiểm tra confirm password
        if (!validateConfirmPassword()) {
            showAlert('Passwords do not match', 'danger');
            return;
        }

        const submitButton = e.target.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Resetting...';

        try {
            const response = await fetch('/api/forgot-password/reset-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email, password })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to reset password');
            }

            showAlert('Password reset successfully. Redirecting to login...', 'success');
            setTimeout(() => window.location.href = '/login', 2000);
        } catch (error) {
            showAlert(error.message, 'danger');
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-save me-2"></i>Reset Password';
        }
    });
}

function validatePassword(password) {
    const requirements = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /[0-9]/.test(password),
        special: /[!@#$%^&*]/.test(password)
    };

    // Cập nhật visual indicators
    Object.keys(requirements).forEach(req => {
        const element = document.getElementById(`${req}-check`);
        if (element) {
            const icon = element.querySelector('i');
            icon.className = requirements[req] 
                ? 'fas fa-check text-success' 
                : 'fas fa-times text-danger';
        }
    });

    return Object.values(requirements).every(req => req);
}

function validateConfirmPassword() {
    const confirmPassword = document.getElementById('confirmPassword');
    const password = document.getElementById('newPassword').value;
    const errorDiv = document.getElementById('confirmPasswordError');
    
    if (confirmPassword.value && confirmPassword.value !== password) {
        confirmPassword.classList.add('is-invalid');
        confirmPassword.classList.remove('is-valid');
        errorDiv.textContent = 'Passwords do not match';
        return false;
    } else if (confirmPassword.value) {
        confirmPassword.classList.remove('is-invalid');
        confirmPassword.classList.add('is-valid');
        errorDiv.textContent = '';
        return true;
    }
    return false;
}

// Thêm các hàm mới
function showAlert(message, type) {
    const alertId = type === 'success' ? 'successMessage' : 'errorMessage';
    const alertElement = document.getElementById(alertId);
    const messageElement = type === 'danger' ? document.getElementById('errorText') : null;
    
    if (messageElement) {
        messageElement.textContent = message;
    }
    
    alertElement.classList.remove('d-none');
    alertElement.classList.add('show');
    
    // Tự động ẩn alert sau 5 giây
    setTimeout(() => {
        alertElement.classList.remove('show');
        setTimeout(() => alertElement.classList.add('d-none'), 300);
    }, 5000);
}

function showStep(step) {
    // Ẩn tất cả các form
    document.getElementById('emailForm').closest('.ex-form-1').style.display = 'none';
    document.getElementById('otpForm').closest('.ex-form-1').style.display = 'none';
    document.getElementById('passwordForm').closest('.ex-form-1').style.display = 'none';
    
    // Hiển thị form tương ứng
    switch(step) {
        case 'emailStep':
            document.getElementById('emailForm').closest('.ex-form-1').style.display = 'block';
            break;
        case 'otpStep':
            document.getElementById('otpForm').closest('.ex-form-1').style.display = 'block';
            break;
        case 'passwordStep':
            document.getElementById('passwordForm').closest('.ex-form-1').style.display = 'block';
            break;
    }
}

function startTimer() {
    let timeLeft = 300; // 5 minutes in seconds
    const timerDisplay = document.createElement('p');
    timerDisplay.className = 'text-muted mt-3';
    document.getElementById('otpForm').appendChild(timerDisplay);
    
    clearInterval(timer);
    timer = setInterval(() => {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerDisplay.textContent = `Time remaining: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
            clearInterval(timer);
            timerDisplay.textContent = 'OTP expired. Please request a new one.';
            document.querySelector('#otpForm button[type="submit"]').disabled = true;
        }
        timeLeft--;
    }, 1000);
}

// Khởi tạo form ban đầu
document.addEventListener('DOMContentLoaded', function() {
    showStep('emailStep');
});
</script>

<style>
.alert {
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.alert-success {
    background-color: #d1e7dd;
    color: #0f5132;
}

.alert-danger {
    background-color: #f8d7da;
    color: #842029;
}

.form-control-submit-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.8rem 2rem;
    font-weight: 500;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.form-control-submit-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.btn-outline-secondary {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.8rem 2rem;
    font-weight: 500;
    border-radius: 4px;
    transition: all 0.3s ease;
}
.form-control.is-invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
}

.form-control.is-valid {
    border-color: #198754;
    box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25);
}

.invalid-feedback {
    display: block;
    color: #dc3545;
    font-size: 0.875em;
    margin-top: 0.25rem;
}

.form-floating > .form-control:focus ~ label,
.form-floating > .form-control:not(:placeholder-shown) ~ label {
    color: #0d6efd;
    opacity: 0.8;
}

.form-floating > .form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.alert.show {
    animation: fadeIn 0.3s ease forwards;
}

.otp-input {
    width: 70px;
}

.d-flex {
    display: flex;
    justify-content: space-between;
}

.form-floating {
    flex: 1;
}

/* Thêm styles cho password requirements */
.password-requirements {
    margin-top: 10px;
    padding: 10px;
    border-radius: 4px;
    background-color: #f8f9fa;
}

.password-requirements ul {
    list-style: none;
    padding-left: 0;
}

.password-requirements li {
    margin-bottom: 5px;
}

.password-requirements i {
    margin-right: 5px;
    width: 16px;
}

.text-success {
    color: #198754 !important;
}

.text-danger {
    color: #dc3545 !important;
}
</style>

<div th:replace="~{footer}"></div>
