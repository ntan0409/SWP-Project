<div th:replace="~{header}"></div>

<div class="container mb-3">
    <div class="row">
        <div class="col-md-12">
            <h3>Edit Children</h3>
            <form id="editChildrenForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="childId" th:value="${childrenId}">
                <input type="hidden" id="userId" th:value="${currentUser.id}">
                <div class="mb-3">
                    <label for="fullName" class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="fullName" name="fullName" required>
                </div>
                
                <div class="mb-3">
                    <label for="birthDate" class="form-label">Birth Date</label>
                    <input type="date" class="form-control" id="birthDate" name="birthDate" required>
                </div>
                
                <div class="mb-3">
                    <label for="gender" class="form-label">Gender</label>
                    <select class="form-control" id="gender" name="gender" required>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-primary">Update</button>
                <a href="/children" class="btn btn-secondary">Cancel</a>
            </form>
        </div>
    </div>
</div>

<script>
let csrfToken, csrfHeader;
try {
    csrfToken = document.querySelector("meta[name='_csrf']")?.content || '';
    csrfHeader = document.querySelector("meta[name='_csrf_header']")?.content || 'X-CSRF-TOKEN';
} catch (e) {
    console.warn('CSRF meta tags not found');
    csrfToken = '';
    csrfHeader = 'X-CSRF-TOKEN';
}
// Lấy ngày hiện tại và định dạng nó thành YYYY-MM-DD
const today = new Date();
const dd = String(today.getDate()).padStart(2, '0');
const mm = String(today.getMonth() + 1).padStart(2, '0'); // January is 0!
const yyyy = today.getFullYear();
const maxDate = yyyy + '-' + mm + '-' + dd;

// Đặt giá trị max cho input
document.getElementById('birthDate').setAttribute('max', maxDate);

// Thêm sự kiện để kiểm tra khi người dùng thay đổi giá trị
document.getElementById('birthDate').addEventListener('change', function(e) {
    const selectedDate = new Date(this.value);
    if (selectedDate > today) {
        alert('Birth date cannot be in the future');
        this.value = ''; // Xóa giá trị đã chọn
    }
});

document.addEventListener('DOMContentLoaded', async () => {
    const childId = document.getElementById('childId').value;
    await loadChildData(childId);
});

async function loadChildData(childId) {
    try {
        const response = await fetch(`/api/children/${childId}`);
        if (!response.ok) throw new Error('Failed to fetch child data');
        const child = await response.json();
        
        document.getElementById('fullName').value = child.fullName;
        document.getElementById('birthDate').value = child.birthDate;
        document.getElementById('gender').value = child.gender;
    } catch (error) {
        console.error('Error:', error);
        showError('Failed to load child data');
    }
}

async function handleSubmit(event) {
    event.preventDefault();
    const childId = document.getElementById('childId').value;
    
    const formData = {
        id: childId,
        fullName: document.getElementById('fullName').value,
        birthDate: document.getElementById('birthDate').value,
        gender: document.getElementById('gender').value,
        userId: document.getElementById('userId').value
    };

    console.log('Sending data:', formData);

    try {
        const response = await fetch(`/api/children/${childId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            },
            body: JSON.stringify(formData)
        });

        if (!response.ok) {
            const errorData = await response.text();
            console.error('Server response:', errorData);
            throw new Error(`Failed to update child: ${errorData}`);
        }
        
        window.location.href = '/children';
    } catch (error) {
        console.error('Error:', error);
        showError(error.message);
    }
}


function showError(message) {
    alert(message); // Replace with your preferred notification system
}

</script>

<div th:replace="~{footer}"></div>